# 🔀 多路径决策树功能说明

## 功能概述

多路径决策树是盘面分析中的核心功能，它通过可视化的流程图展示股票交易决策的逻辑路径，帮助投资者在复杂的市场环境中做出正确的交易决策。

**新增功能：时间动态调整**
- 根据当前时间自动调整盘面分析内容
- 盘前时段：显示盘前作战指南和盘中动态操作
- 盘中时段：显示盘中动态操作和动态风控
- 盘后时段：显示盘后总结和明日计划

## 技术实现

### 后端AI提示词
- 在 `StockAnalysisAI.java` 中集成了Mermaid图表语法
- AI会自动生成标准格式的决策树代码
- 支持复杂的条件分支和操作指令
- **新增：时间动态调整逻辑，根据{{currentTime}}自动适配内容**

### 前端渲染组件
- `MermaidChart.js` 组件负责图表渲染
- Web端：使用Mermaid库渲染SVG图表
- 移动端：智能解析Mermaid代码为友好文本格式

## 支持的图表类型

### 1. 基础流程图 (graph TB)
```
graph TB
    A[开始] --> B[条件判断]
    B -->|是| C[执行操作A]
    B -->|否| D[执行操作B]
```

### 2. 决策树 (graph LR)
```
graph LR
    A[价格突破？] -->|是| B[加仓]
    A -->|否| C[观察]
```

### 3. 时序图 (sequenceDiagram)
```
sequenceDiagram
    participant A as 投资者
    participant B as 市场
    A->>B: 观察信号
    B->>A: 返回数据
```

## 使用示例

### 时间动态调整功能

#### 盘前时段（09:00前）
AI会自动输出盘前作战指南和盘中动态操作手册：

```
- [H] 盘前作战指南
  - [S] 隔夜信号：美股消费电子板块+3.2%，北向盘前溢价0.8%
  - [S] 关键点位：支撑￥38.50（BOLL中轨）/压力￥40.36（前高）
  - [S] 操作预案：高开＞1%量比＞1.5 ▶ 追涨5%仓位；低开破￥38.50观察30分钟反抽
  - [S] 特情警报：10:00工信部低空经济发布会，14:30大宗解禁500万股

- [H] 盘中动态操作手册
  - [S] 多路径决策树（实时更新）
  ```mermaid
  graph TB
      A[价格突破￥39.60？] -->|是| B[量能验证]
      A -->|否| C[是否回踩￥38.80？]
      B -->|量比＞1.2| D[▶ 加仓10% → 目标￥40.50]
      B -->|量比＜1.0| E[▶ 减仓20% → 观察二次攻击]
      C -->|缩量至70%| F[▶ 金字塔补仓]
      C -->|放量破位| G[▶ 止损]
  ```
  - [S] 主力行为跟踪：10:00-10:30关注万手大单，13:00-13:30观察盘口压单
  - [S] 分时战术：缺口引力战、T+0套利术、尾盘突袭侦测
```

#### 盘中时段（09:30-15:00）
AI只输出盘中动态操作和动态风控：

```
- [H] 盘中动态操作手册
  - [S] 多路径决策树（实时更新）
  ```mermaid
  graph TB
      A[价格突破￥39.60？] -->|是| B[量能验证]
      A -->|否| C[是否回踩￥38.80？]
      B -->|量比＞1.2| D[▶ 加仓10% → 目标￥40.50]
      B -->|量比＜1.0| E[▶ 减仓20% → 观察二次攻击]
      C -->|缩量至70%| F[▶ 金字塔补仓]
      C -->|放量破位| G[▶ 止损]
  ```
  - [S] 实时策略：突破￥39.60量比＞1.2 ▶ 加仓10%；跌破￥38.80放量 ▶ 减仓20%
  - [S] 主力监测：当前量比1.8，主力净流入2.1亿，建议跟随操作

- [H] 动态风控引擎
  - [S] 黑天鹅应急：政策利空突袭 ▶ 立即砍仓至50%；个股闪崩预警 ▶ 检查融资余额
  - [S] 仓位平衡：当前仓位45%，情绪系数1.2，技术系数1.0，建议维持
```

#### 盘后时段（15:00后）
AI只输出盘后总结和明日计划：

```
- [H] 盘后总结与明日计划
  - [S] 今日复盘：主力净流出6.3亿，融资逆势增1.3亿，多空分歧明显
  - [S] 明日关键点：支撑￥39.00/压力￥40.50，变盘窗口10:30
  - [S] 仓位调整：建议明日仓位上限50%，重点观察￥39.00支撑
  - [S] 风险提示：明日14:30大宗解禁，可能冲击股价，建议提前减仓
```

### 盘面分析中的决策树
```
- [H] 盘中动态操作
  - [S] 多路径决策树（实时更新）
  ```mermaid
  graph TB
      A[价格突破￥39.60？] -->|是| B[量能验证]
      A -->|否| C[是否回踩￥38.80？]
      B -->|量比＞1.2| D[▶ 加仓10% → 目标￥40.50]
      B -->|量比＜1.0| E[▶ 减仓20% → 观察二次攻击]
      C -->|缩量至70%| F[▶ 金字塔补仓]
      C -->|放量破位| G[▶ 止损]
  ```
```

## 移动端优化

### 智能文本解析
移动端无法渲染图表时，系统会自动将Mermaid代码解析为易读的文本格式：

```
• 价格突破￥39.60？
  └─ 当是时 → 量能验证
  └─ 当否时 → 是否回踩￥38.80？
• 量能验证
  └─ 当量比＞1.2时 → ▶ 加仓10% → 目标￥40.50
  └─ 当量比＜1.0时 → ▶ 减仓20% → 观察二次攻击
```

### 显示效果
- 清晰的层级结构
- 条件判断逻辑
- 操作指令标识
- 原始代码保留

## 配置选项

### Mermaid配置
```javascript
// 在web/index.html中配置
window.mermaid.initialize({
  startOnLoad: true,
  theme: 'default',
  flowchart: {
    useMaxWidth: true,
    htmlLabels: true
  }
});
```

### 样式定制
```javascript
// 在MermaidChart.js中自定义样式
const styles = StyleSheet.create({
  container: {
    backgroundColor: '#F8F9FA',
    borderRadius: 8,
    // ... 其他样式
  }
});
```

## 故障排除

### 常见问题

1. **图表不显示**
   - 检查Mermaid库是否正确加载
   - 验证代码语法是否正确
   - 查看浏览器控制台错误信息

2. **移动端显示异常**
   - 确认文本解析功能正常
   - 检查样式是否正确应用
   - 验证组件是否正确导入

3. **性能问题**
   - 复杂图表可能导致渲染延迟
   - 考虑简化决策树结构
   - 使用异步渲染优化

### 调试技巧

1. **启用调试模式**
   ```javascript
   console.log('Mermaid代码:', code);
   console.log('解析结果:', parsedText);
   ```

2. **检查环境检测**
   ```javascript
   console.log('Window对象:', typeof window);
   console.log('Mermaid库:', window.mermaid);
   ```

3. **验证代码格式**
   - 确保Mermaid语法正确
   - 检查特殊字符转义
   - 验证节点ID唯一性

## 最佳实践

### 1. 决策树设计
- 保持逻辑清晰简洁
- 避免过多分支节点
- 使用有意义的节点名称
- 包含明确的操作指令

### 2. 时间动态调整
- **盘前时段**：重点准备开盘策略，关注隔夜信号和关键点位
- **盘中时段**：实时跟踪市场变化，动态调整操作策略
- **盘后时段**：总结当日表现，制定明日计划
- 确保内容与当前时段高度相关，避免过时信息

### 3. 代码组织
- 将复杂决策树拆分为多个小图
- 使用注释说明关键逻辑
- 保持代码可读性
- 定期更新和维护

### 4. 用户体验
- 提供清晰的标题和说明
- 优化移动端显示效果
- 支持交互式操作
- 提供多种查看方式
- 根据时间自动调整内容，减少信息冗余

## 更新日志

### v1.1.0 (2025-01-19)
- **新增：时间动态调整功能**
  - 根据当前时间自动调整盘面分析内容
  - 盘前时段：显示盘前作战指南和盘中动态操作
  - 盘中时段：显示盘中动态操作和动态风控
  - 盘后时段：显示盘后总结和明日计划
- 优化移动端文本解析算法
- 改进Mermaid代码解析准确性
- 增强错误处理和调试信息

### v1.0.0 (2025-01-19)
- 初始版本发布
- 支持基础流程图和决策树
- 移动端文本解析功能
- Web端SVG渲染

### v1.2.0 (计划中)
- 支持更多图表类型
- 交互式决策树
- 实时数据更新
- 自定义主题支持
- 历史时段回放功能

## 技术支持

如有问题或建议，请：
1. 检查本文档的故障排除部分
2. 查看代码注释和示例
3. 提交Issue或Pull Request
4. 联系开发团队获取帮助
