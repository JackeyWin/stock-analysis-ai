# 东方财富股票资讯爬取和情感分析脚本

## 功能概述

这个脚本可以自动爬取东方财富网上的股票相关资讯、公告和研报，并使用DeepSeek V3模型进行情感分析，帮助投资者快速了解市场情绪和相关信息。

## 主要功能

### 1. 资讯爬取
- **资讯**: 获取股票相关的新闻资讯
- **公告**: 获取公司发布的公告信息
- **研报**: 获取券商研报和分析报告

### 2. 数据过滤
- 自动过滤最近一周的数据
- 支持自定义时间范围

### 3. 内容获取
- 通过链接获取完整的新闻内容
- 智能内容提取，支持多种网页格式

### 4. 情感分析
- 使用DeepSeek V3模型进行AI情感分析
- 分析结果包括：情感倾向、情感强度、置信度、分析理由

## 文件说明

- `EastMoneyStockNews.py`: 主要的爬取和情感分析脚本
- `test_stock_news.py`: 测试脚本，用于验证功能
- `README_StockNews.md`: 使用说明文档

## 安装依赖

```bash
pip install requests beautifulsoup4 playwright
```

安装Playwright浏览器：
```bash
playwright install chromium
```

**注意**: 本脚本使用HTTP请求直接调用DeepSeek API，不需要安装`deepseek`库。

## 使用方法

### 1. 基本使用

```bash
# 设置环境变量
export DEEPSEEK_API_KEY="your_api_key_here"

# 运行脚本
python EastMoneyStockNews.py 688333
```

### 2. 参数说明

```bash
python EastMoneyStockNews.py <股票代码> [DeepSeek_API_Key]
```

- `股票代码`: 必填，如 688333（铂力特）
- `DeepSeek_API_Key`: 可选，如果不提供则从环境变量读取

### 3. 测试脚本

```bash
python test_stock_news.py
```

## 输出格式

脚本会输出JSON格式的结果，包含以下字段：

```json
{
  "stockCode": "688333",
  "timestamp": 1692000000000,
  "news": [
    {
      "title": "新闻标题",
      "link": "新闻链接",
      "date": "2025-08-12",
      "timeStr": "08-12",
      "content": "新闻内容",
      "sentiment": {
        "sentiment": "正面",
        "score": 8,
        "confidence": 85,
        "reason": "分析理由"
      }
    }
  ],
  "notices": [...],
  "reports": [...]
}
```

## 情感分析结果说明

### 情感倾向
- **正面**: 对股票价格有利好影响
- **负面**: 对股票价格有不利影响
- **中性**: 对股票价格影响不大

### 情感强度
- **0-10分**: 0分最负面，10分最正面
- **5分**: 中性

### 置信度
- **0-100%**: 表示AI分析的置信程度

## 技术特点

### 1. 智能爬取
- 使用Playwright进行页面渲染，支持动态内容
- 多种内容提取策略，提高成功率
- 自动处理相对链接和绝对链接
- **增强的页面等待**: 总等待时间从3秒增加到11秒，确保动态内容完全加载
- **智能元素等待**: 等待关键元素（资讯列表、公告列表、研报列表）出现后再获取内容
- **优化的Playwright配置**: 参考EastMoneyPeerComparison.py的最佳实践
- **智能选择器策略**: 使用多种CSS选择器和文本内容查找，提高元素定位成功率
- **渐进式元素加载**: 支持部分元素加载失败的情况，只要有一个元素成功即可继续

### 2. 内容处理
- 智能内容清理和格式化
- 自动限制内容长度，避免API调用超限
- 支持多种网页结构
- **扩展的内容选择器**: 增加了更多常见的内容容器选择器
- **详细的提取日志**: 记录使用哪种方法成功提取内容
- **多层级选择器策略**: 从精确ID到模糊类名，再到文本内容查找的渐进式策略

### 3. 情感分析
- 专业的股票分析提示词
- 多维度分析（价格影响、基本面、行业、市场情绪）
- 智能JSON解析，支持多种响应格式
- **直接HTTP调用**: 使用requests库直接调用DeepSeek API，避免第三方库依赖

### 4. 错误处理
- 完善的异常处理机制
- 详细的错误日志输出
- 优雅的降级处理
- **多层重试机制**: 
  - 页面获取：最多3次重试，指数退避延迟
  - 新闻内容获取：最多3次重试，轻微指数退避
  - 情感分析：最多3次重试，指数退避延迟
- **智能验证**: 验证页面内容完整性和数据有效性
- **详细进度日志**: 记录每个步骤的执行状态和结果
- **容错性设计**: 即使部分元素加载失败，也能继续处理其他可用数据

## 注意事项

### 1. 使用限制
- 请遵守网站的robots.txt和使用条款
- 建议在请求之间添加适当延时，避免过于频繁
- 注意API调用次数限制

### 2. 数据准确性
- 情感分析结果仅供参考，不构成投资建议
- 建议结合其他分析工具和专业知识
- 定期验证和更新分析模型

### 3. 性能优化
- 对于大量数据，建议分批处理
- 可以添加缓存机制，避免重复分析
- 考虑使用异步处理提高效率

## 示例输出

```bash
$ python EastMoneyStockNews.py 688333

开始获取股票 688333 的资讯数据...
获取到 20 条资讯, 15 条公告, 8 条研报
最近一周: 12 条资讯, 8 条公告, 5 条研报
正在分析资讯情感...
分析资讯: 重点转向AI/AR？歌尔1亿美元支持收购境外显示厂商
正在分析公告情感...
分析公告: 歌尔股份:关于子公司对外投资涉及财务资助的公告
正在分析研报情感...
分析研报: 间接投资Micro-LED知名厂商Plessey，歌尔股份AR领域布局再下一城
{
  "stockCode": "688333",
  "timestamp": 1692000000000,
  "news": [
    {
      "title": "重点转向AI/AR？歌尔1亿美元支持收购境外显示厂商",
      "link": "https://finance.eastmoney.com/a/202508123482104036.html",
      "date": "2025-08-12",
      "timeStr": "08-12",
      "content": "新闻内容...",
      "sentiment": {
        "sentiment": "正面",
        "score": 8,
        "confidence": 85,
        "reason": "收购境外显示厂商有助于提升公司在AR/VR领域的技术实力，对股价有积极影响"
      }
    }
  ],
  "notices": [...],
  "reports": [...]
}
```

## 故障排除

### 1. 常见问题

**问题**: 无法获取页面内容
**解决**: 检查网络连接，确认股票代码正确

**问题**: 情感分析失败
**解决**: 检查DeepSeek API密钥是否正确，确认API配额充足

**问题**: 内容提取为空
**解决**: 网页结构可能发生变化，需要更新选择器

### 2. 调试模式

脚本会输出详细的调试信息到stderr，可以通过以下方式查看：

```bash
python EastMoneyStockNews.py 688333 2> debug.log
```

### 3. 日志分析

查看错误日志：
```bash
tail -f debug.log
```

## 扩展功能

### 1. 批量处理
可以修改脚本支持批量处理多只股票

### 2. 数据存储
可以添加数据库存储功能，保存历史分析结果

### 3. 实时监控
可以添加定时任务，定期获取最新资讯

### 4. 报告生成
可以生成PDF或HTML格式的分析报告

## 技术支持

如果遇到问题，请检查：
1. 依赖库是否正确安装
2. API密钥是否有效
3. 网络连接是否正常
4. 股票代码是否正确

## 更新日志

- v1.0.0: 初始版本，支持基本的资讯爬取和情感分析
- 支持资讯、公告、研报三种类型
- 集成DeepSeek V3模型进行情感分析
- 智能内容提取和格式化
- **v1.1.0**: 更新DeepSeek调用方式，使用直接HTTP请求，移除第三方库依赖
- 添加重试机制和错误处理
- 优化API调用参数和响应解析
- **v1.2.0**: 大幅增强稳定性和可靠性
- 增加页面渲染等待时间（从3秒到11秒）
- 添加智能元素等待机制
- 实现多层重试机制（页面获取、内容获取、情感分析）
- 增强内容提取策略和选择器
- 添加详细的进度日志和错误信息
- 智能验证页面内容完整性和数据有效性
- **v1.3.0**: 优化Playwright配置和元素定位策略
- 参考EastMoneyPeerComparison.py的最佳实践
- 实现智能选择器策略，支持多种CSS选择器和文本内容查找
- 添加渐进式元素加载，提高容错性
- 优化浏览器配置和HTTP头设置
- 增强元素等待和验证逻辑
