# 清理所有盯盘任务功能迁移

## 迁移概述

将"清理所有盯盘任务"功能从分析详情页面迁移到盯盘管理页面，使功能更加集中和合理。

## 迁移内容

### 1. 从分析详情页面移除

**移除的文件**：`mobile-app/src/screens/AnalysisScreen.js`

**移除的内容**：
- 清理所有盯盘任务按钮及其样式
- `handleCleanupAllMonitoring` 函数
- 相关的状态变量和逻辑

**移除原因**：
- 分析详情页面应该专注于显示分析结果
- 清理盯盘任务属于盯盘管理功能，应该放在专门的盯盘管理页面

### 2. 在盯盘管理页面添加

**添加的文件**：`mobile-app/src/screens/MonitoringListScreen.js`

**添加的内容**：
- 清理所有盯盘任务按钮（仅在有待清理任务时显示）
- `handleCleanupAllMonitoring` 函数
- 相关的状态变量和样式

**功能特点**：
- 按钮位置：页面标题下方，仅在有待清理任务时显示
- 确认机制：点击后弹出确认对话框，防止误操作
- 状态管理：清理过程中显示加载状态
- 结果反馈：清理完成后显示成功提示并刷新列表

## 代码变更详情

### 分析详情页面变更

```diff
- {/* 清理所有盯盘任务按钮 */}
- <View style={{ alignItems: 'center' }}>
-   <Button
-     mode="outlined"
-     onPress={handleCleanupAllMonitoring}
-     icon="delete-sweep"
-     style={{ 
-       borderColor: '#f44336', 
-       borderWidth: 2,
-       marginBottom: 8
-     }}
-     textColor="#f44336"
-   >
-     清理所有盯盘任务
-   </Button>
-   <Paragraph style={{ 
-     fontSize: 11, 
-     color: '#666', 
-     textAlign: 'center',
-     lineHeight: 14
-   }}>
-     此操作将停止所有正在运行的盯盘任务
-   </Paragraph>
- </View>

- const handleCleanupAllMonitoring = async () => {
-   // ... 函数实现
- };
```

### 盯盘管理页面变更

```diff
+ // 清理所有盯盘任务状态
+ const [cleanupLoading, setCleanupLoading] = useState(false);

+ // 清理所有盯盘任务
+ const handleCleanupAllMonitoring = async () => {
+   Alert.alert(
+     '确认清理',
+     '此操作将停止所有正在运行的盯盘任务，确定要继续吗？',
+     [
+       { text: '取消', style: 'cancel' },
+       {
+         text: '确定',
+         style: 'destructive',
+         onPress: async () => {
+           setCleanupLoading(true);
+           try {
+             const resp = await ApiService.cleanupAllMonitoringJobs();
+             if (resp?.success) {
+               Alert.alert('清理完成', '所有盯盘任务已停止');
+               loadMonitoringJobs(); // 重新加载列表
+             } else {
+               Alert.alert('清理失败', resp?.message || '请稍后重试');
+             }
+           } catch (e) {
+             console.error('清理所有盯盘任务失败:', e);
+             Alert.alert('网络错误', e?.message || '请稍后重试');
+           } finally {
+             setCleanupLoading(false);
+           }
+         }
+       }
+     ]
+   );
+ };

+ {/* 清理所有盯盘任务按钮 */}
+ {monitoringJobs.length > 0 && (
+   <View style={styles.cleanupButtonContainer}>
+     <Button
+       mode="outlined"
+       onPress={handleCleanupAllMonitoring}
+       loading={cleanupLoading}
+       icon="delete-sweep"
+       style={styles.cleanupButton}
+       textColor="#f44336"
+     >
+       清理所有盯盘任务
+     </Button>
+     <Paragraph style={styles.cleanupButtonText}>
+       此操作将停止所有正在运行的盯盘任务
+     </Paragraph>
+   </View>
+ )}

+ // 新增样式
+ cleanupButtonContainer: {
+   alignItems: 'center',
+   marginTop: 16,
+   paddingHorizontal: 16,
+ },
+ cleanupButton: {
+   borderColor: '#f44336',
+   borderWidth: 2,
+   marginBottom: 8,
+ },
+ cleanupButtonText: {
+   fontSize: 11,
+   color: '#666',
+   textAlign: 'center',
+   lineHeight: 14,
+ },
```

## 迁移效果

### 用户体验改善

1. **功能集中**：盯盘相关功能集中在盯盘管理页面
2. **界面清晰**：分析详情页面更加专注于分析结果展示
3. **操作便捷**：在盯盘管理页面可以同时管理单个和批量盯盘任务

### 代码结构优化

1. **职责分离**：分析页面专注于分析功能，盯盘管理页面专注于盯盘功能
2. **代码复用**：清理功能与盯盘管理逻辑放在一起，便于维护
3. **状态管理**：盯盘相关状态集中在盯盘管理页面

## 测试建议

1. **功能测试**：
   - 在盯盘管理页面点击"清理所有盯盘任务"按钮
   - 确认弹出确认对话框
   - 验证清理功能正常工作
   - 确认清理后列表正确刷新

2. **界面测试**：
   - 验证清理按钮仅在有待清理任务时显示
   - 确认按钮样式和位置正确
   - 验证加载状态显示正常

3. **回归测试**：
   - 确认分析详情页面不再显示清理按钮
   - 验证其他盯盘功能正常工作
   - 确认分析功能不受影响

## 注意事项

1. **权限控制**：清理所有盯盘任务是一个重要操作，确保有适当的权限控制
2. **用户确认**：保留确认对话框，防止误操作
3. **错误处理**：保持良好的错误处理和用户反馈
4. **性能考虑**：清理操作可能涉及多个任务，确保响应及时
